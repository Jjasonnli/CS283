#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "dshlib.h"

// Tried but failed
const unsigned char dragon_data[] = {
    72, ' ', 1, '@', 4, '%', 1, '\n',
    69, ' ', 5, '%', 1, '\n',
    68, ' ', 5, '%', 1, '\n',
    65, ' ', 1, '%', 6, '%', 1, '\n',
    64, ' ', 9, '%', 5, '@', 1, '\n',
    63, ' ', 15, '%', 5, '@', 1, '\n',
    62, ' ', 18, '%', 2, '@', 1, '\n',
    61, ' ', 20, '%', 3, '@', 1, '\n',
    60, ' ', 22, '%', 4, '@', 1, '\n',
    59, ' ', 24, '%', 5, '@', 1, '\n',
    58, ' ', 26, '%', 6, '@', 1, '\n',
    57, ' ', 28, '%', 7, '@', 1, '\n',
    56, ' ', 30, '%', 8, '@', 1, '\n',
    55, ' ', 32, '%', 9, '@', 1, '\n',
    0 // End of compressed data
};



void print_dragon()
{
    const char *dragon[] = {
        "                                                                        @%%%%",                       
        "                                                                     %%%%%%",                         
        "                                                                    %%%%%%",                          
        "                                                                 % %%%%%%%           @",              
        "                                                                %%%%%%%%%%        %%%%%%%",           
        "                                       %%%%%%%  %%%%@         %%%%%%%%%%%%@    %%%%%%  @%%%%",        
        "                                  %%%%%%%%%%%%%%%%%%%%%%      %%%%%%%%%%%%%%%%%%%%%%%%%%%%",          
        "                                %%%%%%%%%%%%%%%%%%%%%%%%%%   %%%%%%%%%%%% %%%%%%%%%%%%%%%",           
        "                               %%%%%%%%%%%%%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%     %%%",            
        "                             %%%%%%%%%%%%%%%%%%%%%%%%%%%%@ @%%%%%%%%%%%%%%%%%%        %%",            
        "                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%%%%",                
        "                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%",              
        "                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%%%%%%@",              
        "      %%%%%%%%@           %%%%%%%%%%%%%%%%        %%%%%%%%%%%%%%%%%%%%%%%%%%      %%",                
        "    %%%%%%%%%%%%%         %%@%%%%%%%%%%%%           %%%%%%%%%%% %%%%%%%%%%%%      @%",                
        "  %%%%%%%%%%   %%%        %%%%%%%%%%%%%%            %%%%%%%%%%%%%%%%%%%%%%%%",                        
        " %%%%%%%%%       %         %%%%%%%%%%%%%             %%%%%%%%%%%%@%%%%%%%%%%%",                       
        "%%%%%%%%%@                % %%%%%%%%%%%%%            @%%%%%%%%%%%%%%%%%%%%%%%%%",                     
        "%%%%%%%%@                 %%@%%%%%%%%%%%%            @%%%%%%%%%%%%%%%%%%%%%%%%%%%%",                  
        "%%%%%%%@                   %%%%%%%%%%%%%%%           %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%",              
        "%%%%%%%%%%                  %%%%%%%%%%%%%%%          %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%      %%%%",  
        "%%%%%%%%%@                   @%%%%%%%%%%%%%%         %%%%%%%%%%%%@ %%%% %%%%%%%%%%%%%%%%%   %%%%%%%%",
        "%%%%%%%%%%                  %%%%%%%%%%%%%%%%%        %%%%%%%%%%%%%      %%%%%%%%%%%%%%%%%% %%%%%%%%%",
        "%%%%%%%%%@%%@                %%%%%%%%%%%%%%%%@       %%%%%%%%%%%%%%     %%%%%%%%%%%%%%%%%%%%%%%%  %%",
        " %%%%%%%%%%                  % %%%%%%%%%%%%%%@        %%%%%%%%%%%%%%   %%%%%%%%%%%%%%%%%%%%%%%%%% %%",
        "  %%%%%%%%%%%%  @           %%%%%%%%%%%%%%%%%%        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  %%%",
        "   %%%%%%%%%%%%% %%  %  %@ %%%%%%%%%%%%%%%%%%          %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    %%%",
        "    %%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%%%%           @%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    %%%%%%%",
        "     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%              %%%%%%%%%%%%%%%%%%%%%%%%%%%%        %%%",
        "      @%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                  %%%%%%%%%%%%%%%%%%%%%%%%%",
        "        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                      %%%%%%%%%%%%%%%%%%%  %%%%%%%",
        "           %%%%%%%%%%%%%%%%%%%%%%%%%%                           %%%%%%%%%%%%%%%  @%%%%%%%%%",
        "              %%%%%%%%%%%%%%%%%%%%           @%@%                  @%%%%%%%%%%%%%%%%%%   %%%",
        "                  %%%%%%%%%%%%%%%        %%%%%%%%%%                    %%%%%%%%%%%%%%%    %",
        "                %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                      %%%%%%%%%%%%%%",
        "                %%%%%%%%%%%%%%%%%%%%%%%%%%  %%%% %%%                      %%%%%%%%%%  %%%@",
        "                     %%%%%%%%%%%%%%%%%%% %%%%%% %%                          %%%%%%%%%%%%%@",
        "                                                                                 %%%%%%%@"
    };

    // Print each line
    for (int i = 0; i < sizeof(dragon) / sizeof(dragon[0]); i++)
    {
        printf("%s\n", dragon[i]);
    }
}



int main()
{
    char cmd_buff[SH_CMD_MAX];  // Buffer for user input
    command_list_t clist;       // List to hold parsed commands
    int rc;                     // Return code from command parser

    // Main shell loop
    while (1)
    {
        // Print the shell prompt
        printf("%s", SH_PROMPT);

        // Read user input
        if (fgets(cmd_buff, SH_CMD_MAX, stdin) == NULL)
        {
            printf("\n");
            break;  // Exit on EOF (Ctrl+D)
        }

        // Remove trailing newline from fgets
        cmd_buff[strcspn(cmd_buff, "\n")] = '\0';

        // Check for built-in commands
        if (strcmp(cmd_buff, EXIT_CMD) == 0)
        {
            exit(OK);
        }
        else if (strcmp(cmd_buff, "dragon") == 0)
        {
            print_dragon();  // Print the compressed Drexel Dragon
            continue;        // Continue the loop after printing
        }

        // Parse the command input
        rc = build_cmd_list(cmd_buff, &clist);

        // Handle parsing results
        if (rc == WARN_NO_CMDS)
        {
            printf("%s", CMD_WARN_NO_CMD);
        }
        else if (rc == ERR_TOO_MANY_COMMANDS)
        {
            printf(CMD_ERR_PIPE_LIMIT, CMD_MAX);
        }
        else if (rc == OK)
        {
            // Print parsed commands
            printf(CMD_OK_HEADER, clist.num);
            for (int i = 0; i < clist.num; i++)
            {
                printf("<%d> %s", i + 1, clist.commands[i].exe);
                if (strlen(clist.commands[i].args) > 0)
                {
                    printf(" [%s]", clist.commands[i].args);
                }
                printf("\n");
            }
        }
    }

    return OK;
}
